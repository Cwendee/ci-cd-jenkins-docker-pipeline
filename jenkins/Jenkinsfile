pipeline {
    agent any

    environment {
        IMAGE_NAME = "ci-cd-flask-app"
        CONTAINER_NAME = "ci-cd-flask-container"
        HOST_PORT = "5001"
        CONTAINER_PORT = "5000"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build') {
            steps {
                sh '''
                    python3 -m venv venv
                    . venv/bin/activate
                    pip install --upgrade pip
                    pip install -r app/requirements.txt
                '''
            }
        }

        stage('Test') {
            steps {
                sh '''
                    . venv/bin/activate
                    pytest app/test_app.py
                '''
            }
        }

        stage('Docker Build') {
            steps {
                sh '''
                    docker build -t $IMAGE_NAME:latest -f docker/Dockerfile .
                '''
            }
        }

        stage('Deploy') {
            steps {
                sh '''
                    echo "Stopping existing container if it exists..."
                    docker rm -f $CONTAINER_NAME || true

                    echo "Starting new container..."
                    docker run -d \
                      --name $CONTAINER_NAME \
                      -p $HOST_PORT:$CONTAINER_PORT \
                      $IMAGE_NAME:latest
                '''
            }
        }

        stage('Health Check') {
            steps {
                sh '''
                    sleep 5
                    curl -f http://localhost:5001/health
                '''
            }
        }
    }
}
